<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Perp Scan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      color-scheme: dark;
      --bg: #000000;            /* Pure black background */
      --card: #0d0d0d;          /* Slightly lifted card background */
      --border: #1a1a1a;        /* Subtle card borders */
      --muted: #6b6b6b;         /* Muted gray text */
      --text: #dcdcdc;          /* Soft off-white text */
      --pill-bg: #111111;       /* Dark pill buttons */
      --pill-text: #e5e5e5;
      --success: #3be879;       /* Bright neon green */
      --danger: #ff5555;        /* Clean red */
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text","Segoe UI", sans-serif;
      min-height: 100vh;
      background: #000000;              /* pure black */
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 24px;
      padding-top: 80px;
    }
    .app {
      width: 100%;
      max-width: 1400px;
    }
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 16px;
      padding: 0 24px;
      backdrop-filter: blur(10px);
      background: rgba(0, 0, 0, 0.25);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      z-index: 9999;
    }
    .topbar-form {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .topbar-form input {
      width: 260px;            /* tighter width for header */
    }
    .topbar-logo {
      height: 40px;
      width: 40px;
      object-fit: contain;
      cursor: pointer;
    }
    .topbar-title {
      font-size: 1.15rem;
      font-weight: 650;
      color: #e5e5e5;
      cursor: pointer;
      margin-right: auto; 
    }
    .topbar-title:hover {
      color: #ffffff;
    }
    /* ---------- HOME SEARCH BAR (landing page) ---------- */
    .home-search {
      margin-top: 16px;
      display: flex;
      gap: 12px;
      justify-content: flex-start;    /* left aligned */
      align-items: center;
    }
    .home-search input {
      width: 440px;                   /* ðŸ‘ˆ fits a full HL address */
      max-width: 100%;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #050505;
      color: var(--text);
      font-size: 0.9rem;
    }
    .home-search button {
      padding: 10px 18px;
      border-radius: 999px;
      background: #111111;
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 0.9rem;
      font-weight: 550;
      cursor: pointer;
    }
    .home-search button:hover {
      background: #1a1a1a;
      color: #ffffff;
    }

    .app header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }
    .tag {
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.35);
      font-size: 0.72rem;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #dcdcdc; /* soft white */
      box-shadow: none;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 18px 18px 14px;
      margin-bottom: 16px;
      box-shadow: none;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
      gap: 10px;
    }
    .card-title {
      font-size: 0.92rem;
      font-weight: 550;
    }
    .card-sub {
      font-size: 0.78rem;
      color: var(--muted);
    }
    .hero-sub {
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .hero-highlight {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.7);               /* dark pill */
      border: 1px solid var(--border);           /* subtle dark border */
      font-size: 0.74rem;
      margin-top: 8px;
      color: var(--text);                        /* white text */
    }
    .hero-highlight-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--success);
      box-shadow: none;
    }
    .form-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.35fr) minmax(0, 1.1fr) auto;
      gap: 10px;
      align-items: end;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }
    .field label {
      color: var(--muted);
    }
    input, select {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #050505;
      color: var(--text);
      padding: 7px 11px;
      font-size: 0.82rem;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }
    input::placeholder {
      color: #6b6b6b; /* softer muted gray */
    }
    input:focus,
    select:focus {
      border-color: #ffffff;      /* white border on focus */
      box-shadow: none;           /* no glow */
      background: #050505;        /* stays dark */
      color: var(--text);         /* keep visible text */
    }
    button {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 10px 18px;
      font-size: 0.86rem;
      font-weight: 550;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      background: #111111;          /* flat dark button */
      color: var(--text);
      box-shadow: none;             /* NO glow */
      white-space: nowrap;
      transition: background 0.12s ease, color 0.12s ease;
    }
    
    button:hover {
      background: #1a1a1a;          /* subtle brightening */
      color: #ffffff;
    }
    
    button:active {
      background: #0c0c0c;
      color: #e5e5e5;
    }
    button[disabled] {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    .status {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 8px;
      min-height: 18px;
    }
    .status-error { color: var(--danger); }
    .status-ok { color: var(--success); }
    .grid-2 {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 16px;
    }
    .mini-label {
      font-size: 0.78rem;
      color: var(--muted);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .summary-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.74rem;
      border: 1px solid var(--border);
      background: #050505;
      color: var(--muted);
      display: inline-flex;
      gap: 6px;
      align-items: baseline;
    }
    .badge-strong {
      color: var(--text);
      font-weight: 540;
    }
    .pill-green { color: var(--success); }
    .pill-red { color: var(--danger); }
  
    /* ---------- TABLES ---------- */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 4px;
      color: var(--text);
    }

    th, td {
      padding: 10px 12px;            /* EVEN column spacing */
      text-align: left;
      border-bottom: 1px solid #111111;
    }

    th {
      font-size: 0.8rem;             /* larger header text */
      font-weight: 550;
      color: #c7c7c7;                /* brighter header */
      background: #050505;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    td {
      color: #e6e6e6;
    }

    /* -------- CLEAN TABLE THEME (matches chart background) -------- */

    table {
      background: transparent !important;   /* no table fill */
    }
    /* Remove header box fill */
    table thead th {
      background: transparent !important;
      border-bottom: 1px solid #1a1a1a;     /* subtle bottom line */
    }
    /* Rows: no fill, only separators */
    table tbody tr {
      background: transparent !important;
    }
    table td {
      border-bottom: 1px solid #111111;     /* subtle separators */
    }
    /* Hover: tiny brightness bump */
    table tbody tr:hover td {
      background: rgba(255, 255, 255, 0.02) !important;
    }

    .table-wrap {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      overflow: hidden;
      background: #000;                    /* no blue gradient */
      max-height: 360px;
    }

    .table-inner-scroll {
      max-height: 360px;
      overflow: auto;
      background: #000;                    /* pure dark */
    }

    .raw-json {
      margin-top: 8px;
      font-size: 0.74rem;
      background: #050505;                 /* darker neutral */
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      overflow: auto;
      max-height: 260px;
      color: var(--muted);
    }

    summary { cursor: pointer; user-select: none; }

    .home-only-text {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 4px;
    }

    /* ---------- TABLE TABS (match range buttons) ---------- */

    /* INACTIVE tab (same as inactive range button) */
    .tab-pill {
      border-radius: 999px;
      border: none;
      background: transparent;
      padding: 8px 18px;            /* â†‘ bigger pill */
      font-size: 0.94rem;           /* â†‘ bigger text */
      color: var(--muted);
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
    }
    /* HOVER effect (same as range buttons) */
    .tab-pill:hover:not(.tab-pill-active) {
      background: rgba(255,255,255,0.05);
      color: var(--text);
    }
    /* ACTIVE tab (match All / 90D active styling) */
    .tab-pill-active {
      background: #ffffff10;               /* subtle white tint */
      color: #ffffff;                      /* bright text */
    }
    .tab-count {
      font-size: 0.72rem;
      opacity: 0.8;
    }
    .range-row {
      display: inline-flex;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: #050505;
      border: 1px solid var(--border);
    }
    .range-btn {
      border-radius: 999px;
      border: none;
      background: transparent;
      padding: 4px 10px;
      font-size: 0.74rem;
      color: var(--muted);
      cursor: pointer;
    }
    .range-btn-active {
      background: #ffffff10;     /* subtle white tint */
      color: #ffffff;            /* white text */
    }
  
    /* ---------- CHART CONTAINERS ---------- */
    #equityChartContainer,
    #pnlChartContainer {
      position: relative;
      width: 100%;
      height: 220px;
      margin-top: 8px;
      background: transparent;              /* no darker panel */
    }
    .chart-toggle {
      display: inline-flex;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: #050505;
      border: 1px solid var(--border);
    }
    .chart-toggle-btn {
      border-radius: 999px;
      border: none;
      background: transparent;
      padding: 4px 10px;
      font-size: 0.78rem;
      color: var(--muted);
      cursor: pointer;
    }
    .chart-toggle-btn.chart-toggle-btn-active {
      background: #22c55e;
      color: #022c22;
    }

    /* Top row: Portfolio snapshot (left) + Perp chart (right) */
    .top-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); /* 50/50 split */
      gap: 16px;
      margin-bottom: 16px;
    }
    
    /* Make sure cards stretch nicely inside the row */
    .top-row .card {
      height: 100%;
    }
    
    /* On smaller screens, stack vertically */
    @media (max-width: 900px) {
      .top-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  
    @media (max-width: 840px) {
      body { padding: 12px; }
      header { flex-direction: column; align-items: flex-start; }
      .form-grid { grid-template-columns: minmax(0, 1fr); align-items: stretch; }
      button { justify-content: center; width: 100%; }
      .grid-2 { grid-template-columns: minmax(0, 1fr); }
      .tabs-row { width: 100%; justify-content: space-between; flex-wrap: wrap; }
      .range-row { margin-top: 8px; }
    }
  </style>
</head>
<body>
<header class="topbar">
  <img src="./assets/PSLOGO.png" class="topbar-logo" onclick="window.location.href='/'">
  <span class="topbar-title" onclick="window.location.href='/'">Perp Scan</span>

  <!-- ðŸ”¹ Right-aligned search bar -->
  <form id="query-form" class="topbar-form">
    <input id="account" name="account" type="text" placeholder="0xâ€¦ / address" required />
    <button id="fetchBtn" type="submit">Search</button>
  </form>
</header>
<div class="app">

<main>
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title" id="hero-title">Scan a Hyperliquid account</div>
        <div id="home-search-bar" class="home-search" style="display:none;">
          <input id="homeAccount" type="text" placeholder="Paste addressâ€¦">
          <button id="homeSearchBtn">Search</button>
        </div>
      </div>
    </div>
  
      <div id="status" class="status"></div>
    </section>
    <!-- ... rest of your main sections ... -->

           <!-- NEW TOP ROW: snapshot (left) + chart (right) -->
      <div class="top-row">
      
        <!-- LEFT: Portfolio snapshot -->
        <section class="card" id="summary-card" style="display:none;">
          <div class="card-header">
            <div>
              <div class="card-title">Portfolio snapshot</div>
              <div class="card-sub">PnL, ROI and cashflow if your Worker returns a summary block.</div>
            </div>
          </div>
          <div class="grid-2">
            <div>
              <div class="mini-label">
                <span>Summary</span>
                <span id="accountLabel" style="font-size:0.75rem;"></span>
              </div>
              <div id="summaryBadges" class="summary-badges"></div>
            </div>
            <div>
              <div class="mini-label"><span>Cashflows / meta</span></div>
              <div id="summaryMeta" class="summary-badges"></div>
            </div>
          </div>
        </section>

        <!-- RIGHT: Perp PnL / balance chart -->
        <section class="card" id="chart-card" style="display:none;">
          <div class="card-header">
            <div>
              <!-- Chart mode toggle -->
              <div class="tabs-row" id="chart-mode-tabs">
                <button type="button"
                        class="tab-pill tab-pill-active"
                        id="chart-tab-pnl"
                        data-chart="pnl">
                  <span>Perp PnL</span>
                </button>
                <button type="button"
                        class="tab-pill"
                        id="chart-tab-balance"
                        data-chart="balance">
                  <span>Perp balance</span>
                </button>
              </div>
              <div class="card-sub" id="chart-subtitle">
                Realized + funding PnL for this window.
              </div>
            </div>
      
            <!-- Range buttons -->
            <div class="range-row">
              <button type="button" class="range-btn range-btn-active" data-range="all">All</button>
              <button type="button" class="range-btn" data-range="90d">90D</button>
              <button type="button" class="range-btn" data-range="30d">30D</button>
              <button type="button" class="range-btn" data-range="7d">7D</button>
              <button type="button" class="range-btn" data-range="1d">1D</button>
            </div>
          </div>
      
          <div id="equityChartContainer">
            <canvas id="equityChart"></canvas>
          </div>
        </section>

      </div> <!-- end .top-row -->

      <section class="card" id="tables-card" style="display:none;">
        <div class="card-header">
          <div>
            <div class="card-title">Account tables</div>
            <div class="card-sub">One full-width table at a time â€” positions, closed trades, or cashflows.</div>
          </div>
        </div>

        <div class="tabs-row">
          <button type="button" class="tab-pill tab-pill-active" id="tab-positions">
            <span>Open positions</span>
            <span class="tab-count" id="positionsCount">(0)</span>
          </button>
          <button type="button" class="tab-pill" id="tab-closed">
            <span>Closed trades</span>
            <span class="tab-count" id="closedCount">(0)</span>
          </button>
          <button type="button" class="tab-pill" id="tab-cash">
            <span>Deposits / withdrawals</span>
            <span class="tab-count" id="cashCount">(0)</span>
          </button>
        </div>

        <div class="mini-label" style="margin-top:8px;">
          <span id="activeTableTitle">Open positions</span>
        </div>

        <div class="table-wrap">
          <div class="table-inner-scroll" id="positionsBlock">
            <div id="positionsTableContainer" style="padding:10px; font-size:0.78rem; color:var(--muted);">
              No positions yet. Run a search above.
            </div>
          </div>
          <div class="table-inner-scroll" id="closedBlock" style="display:none;">
            <div id="closedTableContainer" style="padding:10px; font-size:0.78rem; color:var(--muted);">
              No trades yet. Run a search above.
            </div>
          </div>
          <div class="table-inner-scroll" id="cashBlock" style="display:none;">
            <div id="cashTableContainer" style="padding:10px; font-size:0.78rem; color:var(--muted);">
              No deposits or withdrawals yet. Run a search above.
            </div>
          </div>
        </div>

        <details class="raw-json" id="rawJsonBlock" style="display:none;">
          <summary>Show raw JSON response</summary>
          <pre id="rawJson"></pre>
        </details>
      </section>
    </main>
  </div>

<script>
  let activeTab = "positions";
  let equitySeriesAll = [];
  let pnlSeriesAll = [];
  let equityChart = null;
  let currentRange = "all";      // UI range: all, 90d, 30d, 7d, 1d
  let activeChartMode = "pnl";   // "pnl" or "balance"

    // ðŸ”¹ Funding pagination state (ADD THIS)
  let fundingEventsAll = [];     // full list from Worker
  let fundingPage = 0;           // 0 = newest page
  const FUNDING_PAGE_SIZE = 10;  // 10 per page
  const DEFAULT_BASE_URL = "https://perp-scan-live.liam-alerts.workers.dev";

  function formatNumber(x, decimals = 2) {
    if (x === null || x === undefined || isNaN(Number(x))) return "";
    const n = Number(x);
    const opts = { minimumFractionDigits: decimals, maximumFractionDigits: decimals };
    return n.toLocaleString(undefined, opts);
  }

  function createBadge(label, value, options = {}) {
    if (value === null || value === undefined || value === "") return null;
    const badge = document.createElement("div");
    badge.className = "badge";
    const labelSpan = document.createElement("span");
    labelSpan.textContent = label;
    const valueSpan = document.createElement("span");
    valueSpan.className = "badge-strong";
    if (options.color === "green") valueSpan.classList.add("pill-green");
    if (options.color === "red") valueSpan.classList.add("pill-red");
    valueSpan.textContent = value;
    badge.appendChild(labelSpan);
    badge.appendChild(valueSpan);
    return badge;
  }

  function humanizeDuration(ms) {
    if (ms == null || isNaN(ms)) return "";
    const s = Math.max(0, Math.floor(ms / 1000));
    const days = Math.floor(s / 86400);
    const hours = Math.floor((s % 86400) / 3600);
    const mins = Math.floor((s % 3600) / 60);
    const secs = s % 60;

    const parts = [];
    if (days) parts.push(days + "d");
    if (hours) parts.push(hours + "h");
    if (mins) parts.push(mins + "m");
    if (!days && !hours && !mins) parts.push(secs + "s");
    return parts.join(" ");
  }

  function formatDateTime(ts) {
    if (!ts && ts !== 0) return "";
    const d = new Date(ts);
    return d.toLocaleString("en-GB", {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });
  }

  function buildTable(container, rows, opts = {}) {
    container.innerHTML = "";
    if (!Array.isArray(rows) || rows.length === 0) {
      container.innerHTML =
        '<div style="padding:10px; font-size:0.78rem; color:var(--muted);">No data returned.</div>';
      return;
    }

    const isPositions = opts.type === "positions";
    const isClosed = opts.type === "closed";

    const displayNames = isPositions
      ? {
          coin: "Asset",                 // was "coin"          
          side: "Direction",
          size: "Size",                  // capital S
          entryPx: "Entry Price",
          markPx: "Current Price",
          unrealizedPnl: "Unrealized PnL",
          leverage: "Leverage",          // capital L
          value: "Position Value",
        }
      : isClosed
      ? {
          netPnl: "Net PnL",
          sizeClosed: "Size Closed",
          avgEntryPx: "Entry Price",
          exitPx: "Exit Price",
          durationMs: "Duration",
        }
      : {};

    const hidden = isPositions
      ? new Set(["coinIdx", "notional", "basisPct", "unrealizedPct", "roiPct", "roePct"])
      : isClosed
      ? new Set(["endTs"])
      : new Set([]);

    const keys = Object.keys(rows[0] || {}).filter((k) => {
      const v = rows[0][k];
      if (typeof v === "object" || typeof v === "function") return false;
      if (hidden.has(k)) return false;
      return true;
    });

    if (!keys.length) {
      container.innerHTML =
        '<div style="padding:10px; font-size:0.78rem; color:var(--muted);">Unsupported row format.</div>';
      return;
    }

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const trHead = document.createElement("tr");
    keys.forEach((key) => {
      const th = document.createElement("th");
      th.textContent = displayNames[key] || key;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    rows.forEach((r) => {
      const tr = document.createElement("tr");
      keys.forEach((k) => {
        const td = document.createElement("td");
        let v = r[k];
    
      if (typeof v === "number") {
      
        // ðŸŽ¯ Format leverage as "5x"
        if (k === "leverage") {
          td.textContent = v ? `${v}x` : "";
      
        // ðŸŽ¯ Human format for duration
        } else if (k === "durationMs" && isClosed) {
          td.textContent = humanizeDuration(v);
      
        // ðŸŽ¯ unrealizedPnl + roePct â†’ "-$2,870.69 (-51.78%)"
        } else if (k === "unrealizedPnl") {
          const sign = v >= 0 ? "" : "-";
          const baseText = sign + "$" + formatNumber(Math.abs(v), 2);
      
          const roe = typeof r.roePct === "number" ? r.roePct : null;
          let roeText = "";
          if (roe !== null) {
            const pctSign = roe >= 0 ? "" : "-";
            roeText = ` (${pctSign}${formatNumber(Math.abs(roe), 2)}%)`;
          }
      
          td.textContent = baseText + roeText;
      
          if (v > 0) td.style.color = "var(--success)";
          if (v < 0) td.style.color = "var(--danger)";
      
        // ðŸŽ¯ All other numbers (entryPx, markPx, size, etc.)
        } else {
          const decimals =
            k === "entryPx" || k === "markPx" ? 4 : 2;
          td.textContent = formatNumber(v, decimals);
        }
      
      } else {
        td.textContent = v == null ? "" : String(v);
      }
    
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    container.appendChild(table);
  }

  function renderFundingTable(container) {
    container.innerHTML = "";
  
    const start = fundingPage * FUNDING_PAGE_SIZE;
    const end = start + FUNDING_PAGE_SIZE;
    const pageItems = fundingEventsAll.slice(start, end);
  
    // Header
    const header = document.createElement("div");
    header.style.padding = "8px 10px";
    header.style.fontSize = "0.78rem";
    header.style.color = "var(--muted)";
    header.textContent =
      `Showing ${start + 1}â€“${Math.min(end, fundingEventsAll.length)} of ${fundingEventsAll.length} transfers`;
    container.appendChild(header);
  
    if (pageItems.length === 0) {
      const empty = document.createElement("div");
      empty.style.padding = "10px";
      empty.style.color = "var(--muted)";
      empty.textContent = "No transfers.";
      container.appendChild(empty);
      return;
    }
  
    // Table
    const table = document.createElement("table");
    table.innerHTML = `
      <thead>
        <tr>
          <th>Date / Time</th>
          <th>Direction</th>
          <th>Amount (USDC)</th>
          <th>Note</th>
          <th>Tx Hash</th>
        </tr>
      </thead>
    `;
    const tbody = document.createElement("tbody");
  
    pageItems.forEach(ev => {
      const shortHash =
        ev.hash && ev.hash.length > 14
          ? `${ev.hash.slice(0, 10)}â€¦${ev.hash.slice(-6)}`
          : (ev.hash || "");
  
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${formatDateTime(ev.time)}</td>
        <td>${ev.direction === "IN" ? "Deposit" : "Withdrawal"}</td>
        <td>${formatNumber(ev.usdcValue ?? ev.amount ?? 0, 2)}</td>
        <td>${ev.note || ""}</td>
        <td>${shortHash}</td>
      `;
      tbody.appendChild(tr);
    });
  
    table.appendChild(tbody);
    container.appendChild(table);
  
    // Pagination buttons
    const nav = document.createElement("div");
    nav.style.marginTop = "10px";
    nav.style.display = "flex";
    nav.style.justifyContent = "space-between";
  
    const prevBtn = document.createElement("button");
    prevBtn.textContent = "â† Prev";
    prevBtn.disabled = fundingPage === 0;
    prevBtn.onclick = () => {
      fundingPage -= 1;
      renderFundingTable(container);
    };
  
    const nextBtn = document.createElement("button");
    nextBtn.textContent = "Next â†’";
    nextBtn.disabled = end >= fundingEventsAll.length;
    nextBtn.onclick = () => {
      fundingPage += 1;
      renderFundingTable(container);
    };
  
    nav.appendChild(prevBtn);
    nav.appendChild(nextBtn);
    container.appendChild(nav);
  }

  function setDetailMode(isDetail) {
    const summaryCard = document.getElementById("summary-card");
    const tablesCard = document.getElementById("tables-card");
    const chartCard = document.getElementById("chart-card");
    const pnlChartCard = document.getElementById("pnl-chart-card"); // might not exist, safe
    const heroTitle = document.getElementById("hero-title");
    const homeSearchBar = document.getElementById("home-search-bar");
  
    if (isDetail) {
      // Show detail UI
      if (summaryCard) summaryCard.style.display = "";
      if (tablesCard) tablesCard.style.display = "";
      if (chartCard) chartCard.style.display = "";
      if (pnlChartCard) pnlChartCard.style.display = "none";
  
      // Update title
      if (heroTitle) heroTitle.textContent = "Account detail view";
  
      // Hide home search bar
      if (homeSearchBar) homeSearchBar.style.display = "none";
  
    } else {
      // Hide detail UI
      if (summaryCard) summaryCard.style.display = "none";
      if (tablesCard) tablesCard.style.display = "none";
      if (chartCard) chartCard.style.display = "none";
      if (pnlChartCard) pnlChartCard.style.display = "none";
  
      // Update title
      if (heroTitle) heroTitle.textContent = "Scan a Hyperliquid account";
  
      // Show home search bar
      if (homeSearchBar) homeSearchBar.style.display = "flex";
    }
  }

  function switchTab(tab) {
    activeTab = tab;
    const posTab = document.getElementById("tab-positions");
    const closedTab = document.getElementById("tab-closed");
    const cashTab = document.getElementById("tab-cash");
    const positionsBlock = document.getElementById("positionsBlock");
    const closedBlock = document.getElementById("closedBlock");
    const cashBlock = document.getElementById("cashBlock");
    const title = document.getElementById("activeTableTitle");

    if (tab === "positions") {
      posTab.classList.add("tab-pill-active");
      closedTab.classList.remove("tab-pill-active");
      cashTab.classList.remove("tab-pill-active");
      positionsBlock.style.display = "";
      closedBlock.style.display = "none";
      cashBlock.style.display = "none";
      title.textContent = "Open positions";
    } else if (tab === "closed") {
      closedTab.classList.add("tab-pill-active");
      posTab.classList.remove("tab-pill-active");
      cashTab.classList.remove("tab-pill-active");
      closedBlock.style.display = "";
      positionsBlock.style.display = "none";
      cashBlock.style.display = "none";
      title.textContent = "Closed trades";
    } else {
      cashTab.classList.add("tab-pill-active");
      posTab.classList.remove("tab-pill-active");
      closedTab.classList.remove("tab-pill-active");
      cashBlock.style.display = "";
      positionsBlock.style.display = "none";
      closedBlock.style.display = "none";
      title.textContent = "Deposits / withdrawals";
    }
  }

  function formatEquityLabel(ts, range) {
    const d = new Date(ts);
    if (range === "1d") {
      return d.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" });
    }
    return d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
  }

  // Map UI range -> backend ?period=
  function mapRangeToPeriod(range) {
    if (range === "1d") return "day";       // HL perpDay (13 points)
    if (range === "7d") return "week";      // HL perpWeek
    if (range === "30d") return "month";    // HL perpMonth
    if (range === "90d") return "90d";      // custom rolling 90d from perpAllTime
    return "allTime";                       // default = full history
  }

    function updateChartSubtitle() {
    const sub = document.getElementById("chart-subtitle");
    if (!sub) return;
  
    if (activeChartMode === "pnl") {
      sub.textContent = "Realized + funding PnL for this window.";
    } else {
      sub.textContent = "Perp account value over time for this window.";
    }
  }

  function renderEquityChart(range) {
    const card = document.getElementById("chart-card");
    const hasEquity = Array.isArray(equitySeriesAll) && equitySeriesAll.length > 0;
    const hasPnl = Array.isArray(pnlSeriesAll) && pnlSeriesAll.length > 0;
  
    // Nothing to show
    if (!hasEquity && !hasPnl) {
      if (card) card.style.display = "none";
      return;
    }
    if (card) card.style.display = "";
  
    // Choose source series based on chart mode
    let source = [];
    if (activeChartMode === "pnl" && hasPnl) {
      source = pnlSeriesAll.map(pt => ({ ts: pt.ts, value: pt.pnl }));
    } else if (activeChartMode === "balance" && hasEquity) {
      source = equitySeriesAll.map(pt => ({ ts: pt.ts, value: pt.equity }));
    }
  
    // Fallback: if selected mode has no data, switch to the other
    if (!source.length) {
      if (hasEquity) {
        activeChartMode = "balance";
        source = equitySeriesAll.map(pt => ({ ts: pt.ts, value: pt.equity }));
      } else if (hasPnl) {
        activeChartMode = "pnl";
        source = pnlSeriesAll.map(pt => ({ ts: pt.ts, value: pt.pnl }));
      }
    }
  
    if (!source.length) {
      if (card) card.style.display = "none";
      return;
    }
  
    const dayMs = 24 * 60 * 60 * 1000;
    const firstTs = source[0].ts;
    const lastTs  = source[source.length - 1].ts;
    const totalSpan = lastTs - firstTs;
  
    // Normal range windowing
    let cutoff = null;
    if (range === "1d")       cutoff = lastTs - dayMs;
    else if (range === "7d")  cutoff = lastTs - 7 * dayMs;
    else if (range === "30d") cutoff = lastTs - 30 * dayMs;
    else if (range === "90d") cutoff = lastTs - 90 * dayMs;
  
    let filtered = source;
    if (cutoff !== null) {
      filtered = source.filter(p => p.ts >= cutoff);
  
      // Fallback if too few points (except 7D)
      let minPoints = 2;
      if (range === "1d") minPoints = 4;
      else if (range === "30d") minPoints = 4;
  
      if (range !== "7d" && filtered.length < minPoints) {
        const N = Math.min(10, source.length);
        filtered = source.slice(-N);
      }
    }
  
    const labelRange = totalSpan <= dayMs ? "1d" : range;
    const labels = filtered.map(p => formatEquityLabel(p.ts, labelRange));
    const values = filtered.map(p => p.value);
  
    // Decide line color based on performance (up = green, down = red)
    let lineColor, fillColor;
    if (values.length >= 2) {
      const firstVal = values[0];
      const lastVal  = values[values.length - 1];
      const isUp = lastVal >= firstVal;
  
      lineColor = isUp
        ? "rgba(34,197,94,1)"      // green
        : "rgba(239,68,68,1)";     // red
  
      fillColor = isUp
        ? "rgba(34,197,94,0.15)"
        : "rgba(239,68,68,0.15)";
    } else {
      // Fallback neutral if we only have one point
      lineColor = "rgba(148,163,184,1)";
      fillColor = "rgba(148,163,184,0.15)";
    }
  
    const ctx = document.getElementById("equityChart").getContext("2d");
  
    const labelText = activeChartMode === "pnl" ? "Perp PnL" : "Perp balance";
    const tooltipPrefix = activeChartMode === "pnl"
      ? "PnL: $"
      : "Perp balance: $";
  
    if (equityChart) {
      equityChart.data.labels = labels;
      equityChart.data.datasets[0].data = values;
      equityChart.data.datasets[0].label = labelText;
      equityChart.data.datasets[0].borderColor = lineColor;
      equityChart.data.datasets[0].backgroundColor = fillColor;
  
      equityChart.options.plugins.tooltip.callbacks.label = function (ctx) {
        return tooltipPrefix + formatNumber(ctx.parsed.y, 2);
      };
  
      equityChart.update();
    } else {
      // Animation: draw line from left to right
      const totalDuration = 1500; // ms for full draw
      const delayBetweenPoints = values.length
        ? totalDuration / values.length
        : 0;

      const animation = {
        x: {
          type: "number",
          easing: "linear",
          duration: delayBetweenPoints,
          from: NaN,
          delay(ctx) {
            if (ctx.type !== "data" || ctx.xStarted) return 0;
            ctx.xStarted = true;
            return ctx.dataIndex * delayBetweenPoints;
          },
        },
        y: {
          type: "number",
          easing: "linear",
          duration: delayBetweenPoints,
          from(ctx) {
            if (ctx.type !== "data") return 0;
            if (ctx.dataIndex === 0) {
              // start from first value
              return ctx.chart.scales.y.getPixelForValue(values[0]);
            }
            const prevPoint = ctx.chart
              .getDatasetMeta(ctx.datasetIndex)
              .data[ctx.dataIndex - 1];
            return prevPoint.getProps(["y"], true).y;
          },
          delay(ctx) {
            if (ctx.type !== "data" || ctx.yStarted) return 0;
            ctx.yStarted = true;
            return ctx.dataIndex * delayBetweenPoints;
          },
        },
      };

      equityChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: labelText,
              data: values,
              borderWidth: 2,
              pointRadius: 0,          // ðŸ‘ˆ hide points by default
              pointHoverRadius: 4,     // ðŸ‘ˆ show a dot on hover
              pointHitRadius: 8,       // easier to hover
              tension: 0.25,
              borderColor: lineColor,
              backgroundColor: fillColor,
              fill: false,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation, // ðŸ‘ˆ the left-to-right draw animation
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function (ctx) {
                  return tooltipPrefix + formatNumber(ctx.parsed.y, 2);
                },
              },
            },
          },
          scales: {
            x: {
              ticks: { maxTicksLimit: 6 },
              grid: { display: false },
              border: { display: false },  // no bottom axis line
            },
            y: {
              ticks: {
                maxTicksLimit: 5,
                callback: (value) => formatNumber(value, 0),
              },
              grid: { display: false },    // no horizontal grid lines
              border: { display: false },  // no left axis line
            },
          },
        },
      });
    }
  
    // Highlight active range button
    document.querySelectorAll(".range-btn").forEach(btn => {
      if (btn.dataset.range === range) {
        btn.classList.add("range-btn-active");
      } else {
        btn.classList.remove("range-btn-active");
      }
    });
  
    // Keep subtitle in sync (PnL vs balance)
    updateChartSubtitle();
  }

async function runFetch(skipRedirect, rangeOverride, options = {}) {
  const updateTables = options.updateTables !== false; // default true

  const accountInput = document.getElementById("account");
  const statusEl = document.getElementById("status");
  const fetchBtn = document.getElementById("fetchBtn");

  // UI range (graph buttons): all, 90d, 30d, 7d, 1d
  const uiRange = rangeOverride || currentRange || "all";
  currentRange = uiRange;

  // Backend ?period value: day/week/month/allTime/90d
  const period = mapRangeToPeriod(uiRange);

  const account = accountInput.value.trim();

  if (!account) {
    statusEl.textContent = "Please enter an account address.";
    statusEl.className = "status status-error";
    return;
  }

  // URL param handling (account + period) â€” we no longer store base URL
  const currentUrl = new URL(window.location.href);
  const hasAccountInUrl = !!currentUrl.searchParams.get("account");

  if (!skipRedirect && !hasAccountInUrl) {
    currentUrl.searchParams.set("account", account);
    currentUrl.searchParams.set("period", uiRange); // store UI range in URL
    window.location.href = currentUrl.toString();
    return;
  }

  setDetailMode(true);
  switchTab("positions");

  // ðŸ”¹ Use hardcoded Worker URL instead of DOM input
  let baseUrl = DEFAULT_BASE_URL.replace(/\/+$/, "");
  const url =
    baseUrl +
    "/pnlClean?account=" +
    encodeURIComponent(account) +
    "&period=" +
    encodeURIComponent(period) +
    (updateTables ? "&positions=1&closed=1" : "&positions=0&closed=0");

  statusEl.textContent = "Fetching from " + url + " â€¦";
  statusEl.className = "status";
  fetchBtn.disabled = true;

  try {
    const res = await fetch(url, {
      method: "GET",
      headers: { Accept: "application/json" },
    });

    if (!res.ok) {
      const text = await res.text();
      statusEl.textContent = "Request failed: " + res.status + " " + res.statusText;
      statusEl.className = "status status-error";
      console.error("Error response body:", text);
      return;
    }

    const data = await res.json().catch(() => null);
    if (!data) {
      statusEl.textContent = "Received a non-JSON response from the Worker.";
      statusEl.className = "status status-error";
      return;
    }

    statusEl.textContent = "OK Â· Response received.";
    statusEl.className = "status status-ok";

    // raw JSON block
    const rawBlock = document.getElementById("rawJsonBlock");
    const rawPre = document.getElementById("rawJson");
    rawPre.textContent = JSON.stringify(data, null, 2);
    rawBlock.style.display = "block";

    // account label top-right
    const accountLabel = document.getElementById("accountLabel");
    const accDisplay = (data.account || account || "").toString();
    accountLabel.textContent = accDisplay ? accDisplay.slice(0, 8) + "â€¦" : "";

    // summary badges
    const summaryBadges = document.getElementById("summaryBadges");
    const summaryMeta = document.getElementById("summaryMeta");
    summaryBadges.innerHTML = "";
    summaryMeta.innerHTML = "";

    const tradingPnl   = typeof data.perp_pnl === "number" ? data.perp_pnl : null;
    const portfolioPnl = typeof data.balance_change === "number" ? data.balance_change : null;

    const roiObj = data.roi || {};
    const tradingPct   = typeof roiObj.trading_pct === "number" ? roiObj.trading_pct : null;
    const portfolioPct = typeof roiObj.portfolio_pct === "number" ? roiObj.portfolio_pct : null;

    const pnlBadges = [];

    if (portfolioPnl !== null) {
      const color = portfolioPnl >= 0 ? "green" : "red";
      pnlBadges.push(
        createBadge("Portfolio PnL", "$" + formatNumber(portfolioPnl, 2), { color })
      );
    }
    if (tradingPnl !== null) {
      const color = tradingPnl >= 0 ? "green" : "red";
      pnlBadges.push(
        createBadge("Perp PnL", "$" + formatNumber(tradingPnl, 2), { color })
      );
    }
    if (portfolioPct !== null) {
      const color = portfolioPct >= 0 ? "green" : "red";
      pnlBadges.push(
        createBadge("Portfolio ROI", formatNumber(portfolioPct, 2) + "%", { color })
      );
    }
    if (tradingPct !== null) {
      const color = tradingPct >= 0 ? "green" : "red";
      pnlBadges.push(
        createBadge("Perp ROI", formatNumber(tradingPct, 2) + "%", { color })
      );
    }

    if (!pnlBadges.length) {
      summaryBadges.innerHTML =
        '<span style="font-size:0.78rem; color:var(--muted);">No PnL / ROI fields returned in response.</span>';
    } else {
      pnlBadges.forEach(b => summaryBadges.appendChild(b));
    }

    const anySummary =
      data.summary || data.portfolioSummary || data.portfolio || data.meta || null;

    const deposits =
      anySummary?.deposits ??
      anySummary?.deposited ??
      data.adjustments?.deposits ??
      null;

    const withdrawals =
      anySummary?.withdrawals ??
      anySummary?.withdrawn ??
      data.adjustments?.withdrawals ??
      null;

    const fees = anySummary?.fees ?? null;

    const metaBadges = [];
    if (deposits !== null) {
      metaBadges.push(createBadge("Deposits", "$" + formatNumber(deposits, 2)));
    }
    if (withdrawals !== null) {
      metaBadges.push(createBadge("Withdrawals", "$" + formatNumber(withdrawals, 2)));
    }
    if (fees !== null) {
      metaBadges.push(createBadge("Fees", "$" + formatNumber(fees, 2)));
    }

    const balances = data.balances || {};
    if (balances.perp_now != null) {
      metaBadges.push(
        createBadge("Perp balance now", "$" + formatNumber(balances.perp_now, 2))
      );
    }
    if (balances.portfolio_now != null) {
      metaBadges.push(
        createBadge("Portfolio balance now", "$" + formatNumber(balances.portfolio_now, 2))
      );
    }

    if (!metaBadges.length) {
      summaryMeta.innerHTML =
        '<span style="font-size:0.78rem; color:var(--muted);">No cashflow / balance meta returned.</span>';
    } else {
      metaBadges.forEach(b => summaryMeta.appendChild(b));
    }

    if (updateTables) {
      const positions = data.positions || data.openPositions || data.open || [];
      const closed = data.closed || data.closedTrades || data.trades || [];

      const fundingEvents = data.fundingEvents || [];

      const positionsContainer = document.getElementById("positionsTableContainer");
      const closedContainer = document.getElementById("closedTableContainer");
      const cashContainer = document.getElementById("cashTableContainer");

      buildTable(positionsContainer, positions, { type: "positions" });
      buildTable(closedContainer, closed, { type: "closed" });

      fundingEventsAll = (data.fundingEvents || []).filter(ev => ev.kind === "perpTransfer")
        .sort((a, b) => b.time - a.time);   // newest first
      
      fundingPage = 0;
      renderFundingTable(cashContainer);

      const posCount = document.getElementById("positionsCount");
      const closedCount = document.getElementById("closedCount");
      const cashCount = document.getElementById("cashCount");

      posCount.textContent =
        "(" + (Array.isArray(positions) ? positions.length : 0) + ")";
      closedCount.textContent =
        "(" + (Array.isArray(closed) ? closed.length : 0) + ")";

      const perpEventsCount = fundingEvents.filter(
        (ev) => ev.kind === "perpTransfer",
      ).length;
      cashCount.textContent = "(" + perpEventsCount + ")";
    }

    // --- Perp balance series ---
    equitySeriesAll = Array.isArray(data.equitySeries)
      ? data.equitySeries
      : [];

    if (equitySeriesAll.length) {
      equitySeriesAll = equitySeriesAll
        .map((p) => ({
          ts: Number(p.ts ?? p[0]),
          equity: Number(p.equity ?? p[1]),
        }))
        .filter(
          (p) => Number.isFinite(p.ts) && Number.isFinite(p.equity),
        )
        .sort((a, b) => a.ts - b.ts);
    }

    // --- Perp PnL series ---
    pnlSeriesAll = Array.isArray(data.pnlSeries)
      ? data.pnlSeries
      : [];

    if (pnlSeriesAll.length) {
      pnlSeriesAll = pnlSeriesAll
        .map((p) => ({
          ts: Number(p.ts ?? p[0]),
          pnl: Number(p.pnl ?? p[1]),
        }))
        .filter(
          (p) => Number.isFinite(p.ts) && Number.isFinite(p.pnl),
        )
        .sort((a, b) => a.ts - b.ts);
    }

    // ðŸ”¹ Finally render the unified chart (Perp PnL or Perp balance depending on activeChartMode)
    renderEquityChart(currentRange);

  } catch (err) {
    console.error(err);
    statusEl.textContent = "Error: " + (err?.message || err);
    statusEl.className = "status status-error";
  } finally {
    fetchBtn.disabled = false;
  }
}

  function handleSubmit(event) {
    if (event) event.preventDefault();
    // First manual fetch: use whatever currentRange is (default = "all")
    runFetch(false, currentRange, { updateTables: true });
  }

document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const accountParam = params.get("account");
  const periodParam = params.get("period");

  const accountInput = document.getElementById("account");
  const periodSelect = document.getElementById("period"); // if present

  if (accountParam) accountInput.value = accountParam;

  if (periodParam && ["all","90d","30d","7d","1d"].includes(periodParam)) {
    currentRange = periodParam;
  }

  // Keep the dropdown showing something sane (even if unused)
  if (periodSelect) {
    periodSelect.value = "allTime";
  }

  // ðŸ”¹ Home search bar â†’ trigger topbar search
  const homeSearchBtn = document.getElementById("homeSearchBtn");
  if (homeSearchBtn) {
    homeSearchBtn.addEventListener("click", () => {
      const val = document.getElementById("homeAccount").value.trim();
      if (!val) return;

      document.getElementById("account").value = val;
      handleSubmit(); // run the PnL fetch
    });
  }

  // ðŸ”¹ Topbar search form
  document.getElementById("query-form").addEventListener("submit", handleSubmit);

  // Load detail page automatically if URL contains ?account=
  if (accountParam) {
    setDetailMode(true);
    switchTab("positions");
    runFetch(true, currentRange, { updateTables: true });
  } else {
    setDetailMode(false);
  }

  // Tab switching
  document.getElementById("tab-positions").addEventListener("click", () => switchTab("positions"));
  document.getElementById("tab-closed").addEventListener("click", () => switchTab("closed"));
  document.getElementById("tab-cash").addEventListener("click", () => switchTab("cash"));

  // Chart mode toggle
  const chartTabPnl = document.getElementById("chart-tab-pnl");
  const chartTabBalance = document.getElementById("chart-tab-balance");

  if (chartTabPnl && chartTabBalance) {
    chartTabPnl.addEventListener("click", () => {
      activeChartMode = "pnl";
      chartTabPnl.classList.add("tab-pill-active");
      chartTabBalance.classList.remove("tab-pill-active");
      updateChartSubtitle();
      renderEquityChart(currentRange);
    });

    chartTabBalance.addEventListener("click", () => {
      activeChartMode = "balance";
      chartTabBalance.classList.add("tab-pill-active");
      chartTabPnl.classList.remove("tab-pill-active");
      updateChartSubtitle();
      renderEquityChart(currentRange);
    });
  }

  // Range buttons (1D / 7D / 30D / etc)
  document.querySelectorAll(".range-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const range = btn.dataset.range;
      currentRange = range;
      runFetch(true, range, { updateTables: false });
    });
  });
});
</script>
</body>
</html>
