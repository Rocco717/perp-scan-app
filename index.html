<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Perp Scan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --bg-elevated: #020617;
      --bg-card: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.25);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --danger: #f97373;
      --success: #4ade80;
      --radius-lg: 14px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 45px rgba(15,23,42,0.8);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text","Segoe UI", sans-serif;
      min-height: 100vh;
      background: radial-gradient(circle at top, #0f172a 0, #020617 45%, #000 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 24px;
    }
    .app {
      width: 100%;
      max-width: 1100px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #38bdf8, #0ea5e9 45%, #0369a1 100%);
      box-shadow: 0 0 0 1px rgba(148,163,184,0.35), 0 16px 30px rgba(15,23,42,0.75);
      position: relative;
      overflow: hidden;
    }
    .logo-icon::after {
      content: "";
      position: absolute;
      inset: 18% 16%;
      border-radius: 999px;
      border: 2px solid rgba(15,23,42,0.9);
      border-top-color: transparent;
      border-left-color: transparent;
      transform: rotate(-30deg);
      opacity: 0.9;
    }
    .logo-main {
      font-weight: 650;
      letter-spacing: 0.02em;
      font-size: 1.05rem;
    }
    .logo-sub {
      font-size: 0.78rem;
      color: var(--muted);
    }
    .tag {
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.35);
      font-size: 0.72rem;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,0.35);
    }
    .card {
      background: radial-gradient(circle at top left, #020617 0, #020617 55%, #000 100%);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(15,23,42,0.95);
      padding: 18px 18px 14px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-soft);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
      gap: 10px;
    }
    .card-title {
      font-size: 0.92rem;
      font-weight: 550;
    }
    .card-sub {
      font-size: 0.78rem;
      color: var(--muted);
    }
    .hero-sub {
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .hero-highlight {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(56,189,248,0.4);
      font-size: 0.74rem;
      margin-top: 8px;
    }
    .hero-highlight-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #38bdf8;
    }
    .form-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.35fr) minmax(0, 1.1fr) auto;
      gap: 10px;
      align-items: end;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }
    .field label {
      color: var(--muted);
    }
    input, select {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.96);
      color: var(--text);
      padding: 7px 11px;
      font-size: 0.82rem;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }
    input::placeholder { color: #4b5563; }
    input:focus, select:focus {
      border-color: rgba(56,189,248,0.9);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.5);
      background: radial-gradient(circle at top left, rgba(15,23,42,1) 0, rgba(15,23,42,0.98) 55%);
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 10px 18px;
      font-size: 0.86rem;
      font-weight: 550;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      background: radial-gradient(circle at top left, #0ea5e9 0, #0284c7 42%, #0369a1 100%);
      color: white;
      box-shadow: 0 10px 25px rgba(8,47,73,0.8);
      white-space: nowrap;
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(8,47,73,0.9);
      filter: brightness(1.02);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(8,47,73,0.9);
    }
    button[disabled] {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    .status {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 8px;
      min-height: 18px;
    }
    .status-error { color: var(--danger); }
    .status-ok { color: var(--success); }
    .grid-2 {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 16px;
    }
    .mini-label {
      font-size: 0.78rem;
      color: var(--muted);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .summary-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.74rem;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      display: inline-flex;
      gap: 6px;
      align-items: baseline;
    }
    .badge-strong {
      color: var(--text);
      font-weight: 540;
    }
    .pill-green { color: var(--success); }
    .pill-red { color: var(--danger); }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      margin-top: 4px;
    }
    th, td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(15,23,42,0.9);
    }
    th {
      font-size: 0.74rem;
      font-weight: 540;
      color: var(--muted);
      background: rgba(15,23,42,0.92);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:nth-child(odd) { background: rgba(15,23,42,0.7); }
    tbody tr:nth-child(even) { background: rgba(15,23,42,0.4); }
    tbody tr:hover { background: rgba(30,64,175,0.45); }
    .table-wrap {
      border-radius: var(--radius-md);
      border: 1px solid rgba(15,23,42,0.95);
      overflow: hidden;
      background: radial-gradient(circle at top left, rgba(15,23,42,1) 0, rgba(15,23,42,0.96) 50%);
      max-height: 360px;
    }
    .table-inner-scroll {
      max-height: 360px;
      overflow: auto;
    }
    .raw-json {
      margin-top: 8px;
      font-size: 0.74rem;
      background: #020617;
      border-radius: 10px;
      border: 1px solid rgba(15,23,42,0.95);
      padding: 8px 10px;
      overflow: auto;
      max-height: 260px;
      color: var(--muted);
    }
    summary { cursor: pointer; user-select: none; }
    .home-only-text {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 4px;
    }
    .tabs-row {
      display: inline-flex;
      gap: 8px;
      background: rgba(15,23,42,0.85);
      padding: 4px;
      border-radius: 999px;
      border: 1px solid rgba(31,41,55,0.9);
      margin-bottom: 8px;
    }
    .tab-pill {
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 5px 12px;
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .tab-pill-active {
      background: #16a34a;
      color: #ecfdf3;
    }
    .tab-count {
      font-size: 0.72rem;
      opacity: 0.8;
    }
    .range-row {
      display: inline-flex;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(31,41,55,0.9);
    }
    .range-btn {
      border-radius: 999px;
      border: none;
      background: transparent;
      padding: 4px 10px;
      font-size: 0.74rem;
      color: var(--muted);
      cursor: pointer;
    }
    .range-btn-active {
      background: rgba(56,189,248,0.2);
      color: #e0f2fe;
    }
    #equityChartContainer {
      position: relative;
      width: 100%;
      height: 220px;
      margin-top: 8px;
    }
    #pnlChartContainer {
      position: relative;
      width: 100%;
      height: 220px;
      margin-top: 8px;
    }
    @media (max-width: 840px) {
      body { padding: 12px; }
      header { flex-direction: column; align-items: flex-start; }
      .form-grid { grid-template-columns: minmax(0, 1fr); align-items: stretch; }
      button { justify-content: center; width: 100%; }
      .grid-2 { grid-template-columns: minmax(0, 1fr); }
      .tabs-row { width: 100%; justify-content: space-between; flex-wrap: wrap; }
      .range-row { margin-top: 8px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">
        <div class="logo-icon"></div>
        <div>
          <div class="logo-main">Perp Scan</div>
          <div class="logo-sub">On-chain PnL & positions from your browser</div>
        </div>
      </div>
      <div class="tag">
        <span class="tag-dot"></span>
        <span>v1.4 Â· Address viewer + chart</span>
      </div>
    </header>

    <main>
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title" id="hero-title">Scan a Hyperliquid account</div>
            <div class="hero-sub" id="hero-sub">
              Home = clean, no tables. Once you scan an account, this becomes a shareable detail view URL.
            </div>
            <div class="hero-highlight" id="hero-highlight">
              <span class="hero-highlight-dot"></span>
              <span id="hero-highlight-text">Step 1 â€” Paste an address and hit Fetch.</span>
            </div>
          </div>
        </div>
        <form id="query-form">
          <div class="form-grid">
            <div class="field">
              <label for="baseUrl">Worker base URL</label>
              <input id="baseUrl" name="baseUrl" type="url"
                placeholder="https://perp-scan-live.liam-alerts.workers.dev"
                value="https://perp-scan-live.liam-alerts.workers.dev" />
              <div class="home-only-text" id="home-helper">
                Uses your existing Cloudflare Worker <code>/pnlClean</code> endpoint.
              </div>
            </div>
            <div class="field">
              <label for="account">Account address</label>
              <input id="account" name="account" type="text" placeholder="0xâ€¦ / address" required />
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button id="fetchBtn" type="submit" style="width:100%;">Fetch</button>
            </div>
          </div>
        </form>
        <div id="status" class="status"></div>
      </section>

      <section class="card" id="chart-card" style="display:none;">
        <div class="card-header">
          <div>
            <div class="card-title">Perp balance</div>
            <div class="card-sub">Account value over time for this window.</div>
          </div>
          <div class="range-row">
            <button type="button" class="range-btn range-btn-active" data-range="all">All</button>
            <button type="button" class="range-btn" data-range="90d">90D</button>
            <button type="button" class="range-btn" data-range="30d">30D</button>
            <button type="button" class="range-btn" data-range="7d">7D</button>
            <button type="button" class="range-btn" data-range="1d">1D</button>
          </div>
        </div>
        <div id="equityChartContainer">
          <canvas id="equityChart"></canvas>
        </div>
      </section>

      <section class="card" id="pnl-chart-card" style="display:none;">
        <div class="card-header">
          <div>
            <div class="card-title">Perp PnL</div>
            <div class="card-sub">Realized + funding PnL for this window.</div>
          </div>
      
          <div class="range-row">
            <button type="button" class="range-btn range-btn-active" data-range="all">All</button>
            <button type="button" class="range-btn" data-range="90d">90D</button>
            <button type="button" class="range-btn" data-range="30d">30D</button>
            <button type="button" class="range-btn" data-range="7d">7D</button>
            <button type="button" class="range-btn" data-range="1d">1D</button>
          </div>
        </div>
      
        <div id="pnlChartContainer">
          <canvas id="pnlChart"></canvas>
        </div>
      </section>

      <section class="card" id="summary-card" style="display:none;">
        <div class="card-header">
          <div>
            <div class="card-title">Portfolio snapshot</div>
            <div class="card-sub">PnL, ROI and cashflow if your Worker returns a summary block.</div>
          </div>
        </div>
        <div class="grid-2">
          <div>
            <div class="mini-label">
              <span>Summary</span>
              <span id="accountLabel" style="font-size:0.75rem;"></span>
            </div>
            <div id="summaryBadges" class="summary-badges"></div>
          </div>
          <div>
            <div class="mini-label"><span>Cashflows / meta</span></div>
            <div id="summaryMeta" class="summary-badges"></div>
          </div>
        </div>
      </section>

      <section class="card" id="tables-card" style="display:none;">
        <div class="card-header">
          <div>
            <div class="card-title">Account tables</div>
            <div class="card-sub">One full-width table at a time â€” positions, closed trades, or cashflows.</div>
          </div>
        </div>

        <div class="tabs-row">
          <button type="button" class="tab-pill tab-pill-active" id="tab-positions">
            <span>Open positions</span>
            <span class="tab-count" id="positionsCount">(0)</span>
          </button>
          <button type="button" class="tab-pill" id="tab-closed">
            <span>Closed trades</span>
            <span class="tab-count" id="closedCount">(0)</span>
          </button>
          <button type="button" class="tab-pill" id="tab-cash">
            <span>Deposits / withdrawals</span>
            <span class="tab-count" id="cashCount">(0)</span>
          </button>
        </div>

        <div class="mini-label" style="margin-top:8px;">
          <span id="activeTableTitle">Open positions</span>
        </div>

        <div class="table-wrap">
          <div class="table-inner-scroll" id="positionsBlock">
            <div id="positionsTableContainer" style="padding:10px; font-size:0.78rem; color:var(--muted);">
              No positions yet. Run a search above.
            </div>
          </div>
          <div class="table-inner-scroll" id="closedBlock" style="display:none;">
            <div id="closedTableContainer" style="padding:10px; font-size:0.78rem; color:var(--muted);">
              No trades yet. Run a search above.
            </div>
          </div>
          <div class="table-inner-scroll" id="cashBlock" style="display:none;">
            <div id="cashTableContainer" style="padding:10px; font-size:0.78rem; color:var(--muted);">
              No deposits or withdrawals yet. Run a search above.
            </div>
          </div>
        </div>

        <details class="raw-json" id="rawJsonBlock" style="display:none;">
          <summary>Show raw JSON response</summary>
          <pre id="rawJson"></pre>
        </details>
      </section>
    </main>
  </div>

<script>
  let activeTab = "positions";
  let equitySeriesAll = [];
  let equityChart = null;
  let pnlSeriesAll = [];
  let pnlChart = null;
  let currentRange = "all"; // UI range: all, 90d, 30d, 7d, 1d

  function formatNumber(x, decimals = 2) {
    if (x === null || x === undefined || isNaN(Number(x))) return "";
    const n = Number(x);
    const opts = { minimumFractionDigits: decimals, maximumFractionDigits: decimals };
    return n.toLocaleString(undefined, opts);
  }

  function createBadge(label, value, options = {}) {
    if (value === null || value === undefined || value === "") return null;
    const badge = document.createElement("div");
    badge.className = "badge";
    const labelSpan = document.createElement("span");
    labelSpan.textContent = label;
    const valueSpan = document.createElement("span");
    valueSpan.className = "badge-strong";
    if (options.color === "green") valueSpan.classList.add("pill-green");
    if (options.color === "red") valueSpan.classList.add("pill-red");
    valueSpan.textContent = value;
    badge.appendChild(labelSpan);
    badge.appendChild(valueSpan);
    return badge;
  }

  function humanizeDuration(ms) {
    if (ms == null || isNaN(ms)) return "";
    const s = Math.max(0, Math.floor(ms / 1000));
    const days = Math.floor(s / 86400);
    const hours = Math.floor((s % 86400) / 3600);
    const mins = Math.floor((s % 3600) / 60);
    const secs = s % 60;

    const parts = [];
    if (days) parts.push(days + "d");
    if (hours) parts.push(hours + "h");
    if (mins) parts.push(mins + "m");
    if (!days && !hours && !mins) parts.push(secs + "s");
    return parts.join(" ");
  }

  function formatDateTime(ts) {
    if (!ts && ts !== 0) return "";
    const d = new Date(ts);
    return d.toLocaleString("en-GB", {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });
  }

  function buildTable(container, rows, opts = {}) {
    container.innerHTML = "";
    if (!Array.isArray(rows) || rows.length === 0) {
      container.innerHTML =
        '<div style="padding:10px; font-size:0.78rem; color:var(--muted);">No data returned.</div>';
      return;
    }

    const isPositions = opts.type === "positions";
    const isClosed = opts.type === "closed";

    const displayNames = isPositions
      ? {
          coinIdx: "Ticker",
          side: "Direction",
          entryPx: "Entry Price",
          markPx: "Current Price",
          value: "Position Value",
        }
      : isClosed
      ? {
          netPnl: "Net Pnl",
          sizeClosed: "Size Closed",
          avgEntryPx: "Entry Price",
          exitPx: "Exit Price",
          durationMs: "Duration",
        }
      : {};

    const hidden = isPositions
      ? new Set(["notional", "basisPct", "unrealizedPct", "roiPct"])
      : isClosed
      ? new Set(["endTs"])
      : new Set([]);

    const keys = Object.keys(rows[0] || {}).filter((k) => {
      const v = rows[0][k];
      if (typeof v === "object" || typeof v === "function") return false;
      if (hidden.has(k)) return false;
      return true;
    });

    if (!keys.length) {
      container.innerHTML =
        '<div style="padding:10px; font-size:0.78rem; color:var(--muted);">Unsupported row format.</div>';
      return;
    }

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const trHead = document.createElement("tr");
    keys.forEach((key) => {
      const th = document.createElement("th");
      th.textContent = displayNames[key] || key;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    rows.forEach((r) => {
      const tr = document.createElement("tr");
      keys.forEach((k) => {
        const td = document.createElement("td");
        let v = r[k];
        if (typeof v === "number") {
          if (k === "durationMs" && isClosed) {
            td.textContent = humanizeDuration(v);
          } else {
            const decimals =
              k === "entryPx" || k === "markPx" ? 4 : opts.numericDecimals ?? 4;
            td.textContent = formatNumber(v, decimals);
          }
        } else {
          td.textContent = v == null ? "" : String(v);
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    container.appendChild(table);
  }

  function renderFundingTable(container, events, summary) {
    container.innerHTML = "";

    const perpEvents = (events || [])
      .filter(ev => ev.kind === "perpTransfer")
      .sort((a, b) => b.time - a.time); // newest first

    // Summary block
    const summaryDiv = document.createElement("div");
    summaryDiv.style.padding = "8px 10px";
    summaryDiv.style.fontSize = "0.78rem";
    summaryDiv.style.color = "var(--muted)";

    if (summary && (summary.perpInUSDC || summary.perpOutUSDC || summary.netPerpFlowUSDC)) {
      const inUSDC = Number(summary.perpInUSDC || 0);
      const outUSDC = Number(summary.perpOutUSDC || 0);
      const netUSDC = Number(summary.netPerpFlowUSDC || 0);
      const netSign = netUSDC > 0 ? "+" : netUSDC < 0 ? "âˆ’" : "";
      const netAbs = Math.abs(netUSDC).toFixed(2);

      summaryDiv.textContent =
        `Perp account flow (window): ` +
        `Deposits ${inUSDC.toFixed(2)} USDC Â· ` +
        `Withdrawals ${outUSDC.toFixed(2)} USDC Â· ` +
        `Net ${netSign}${netAbs} USDC`;
    } else {
      summaryDiv.textContent = "Perp deposits and withdrawals for this window.";
    }

    container.appendChild(summaryDiv);

    if (!perpEvents.length) {
      const empty = document.createElement("div");
      empty.style.padding = "10px";
      empty.style.fontSize = "0.78rem";
      empty.style.color = "var(--muted)";
      empty.textContent = "No perp deposits or withdrawals in this period.";
      container.appendChild(empty);
      return;
    }

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const trHead = document.createElement("tr");
    ["Date / Time", "Direction", "Amount (USDC)", "Note", "Tx Hash"].forEach(label => {
      const th = document.createElement("th");
      th.textContent = label;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    perpEvents.forEach(ev => {
      const tr = document.createElement("tr");

      const dateTd = document.createElement("td");
      dateTd.textContent = formatDateTime(ev.time);

      const dirTd = document.createElement("td");
      dirTd.textContent =
        ev.direction === "IN" ? "Deposit (spot â†’ perp)" : "Withdrawal (perp â†’ spot)";

      const amtTd = document.createElement("td");
      const val = Number(ev.usdcValue ?? ev.amount ?? 0);
      amtTd.textContent = formatNumber(val, 2);

      const noteTd = document.createElement("td");
      noteTd.textContent = ev.note || "";

      const hashTd = document.createElement("td");
      const h = ev.hash || "";
      hashTd.textContent =
        h && h.length > 14 ? `${h.slice(0, 10)}â€¦${h.slice(-6)}` : h;

      tr.appendChild(dateTd);
      tr.appendChild(dirTd);
      tr.appendChild(amtTd);
      tr.appendChild(noteTd);
      tr.appendChild(hashTd);
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    container.appendChild(table);
  }

  function setDetailMode(isDetail) {
    const summaryCard = document.getElementById("summary-card");
    const tablesCard = document.getElementById("tables-card");
    const chartCard = document.getElementById("chart-card");
    const pnlChartCard = document.getElementById("pnl-chart-card");
    const heroTitle = document.getElementById("hero-title");
    const heroSub = document.getElementById("hero-sub");
    const heroHighlightText = document.getElementById("hero-highlight-text");
    const homeHelper = document.getElementById("home-helper");
  
    if (isDetail) {
      summaryCard.style.display = "";
      tablesCard.style.display = "";
      chartCard.style.display = "";
      if (pnlChartCard) pnlChartCard.style.display = "";
      heroTitle.textContent = "Account detail view";
      heroSub.textContent = "This URL is now shareable â€” it will auto-load this address and time window.";
      heroHighlightText.textContent = "Tip â€” Bookmark this tab as your personal PnL dashboard.";
      homeHelper.style.display = "none";
    } else {
      summaryCard.style.display = "none";
      tablesCard.style.display = "none";
      chartCard.style.display = "none";
      if (pnlChartCard) pnlChartCard.style.display = "none";
      heroTitle.textContent = "Scan a Hyperliquid account";
      heroSub.textContent = "Home = clean, no tables. Once you scan an account, this becomes a shareable detail view URL.";
      heroHighlightText.textContent = "Step 1 â€” Paste an address and hit Fetch.";
      homeHelper.style.display = "block";
    }
  }

  function switchTab(tab) {
    activeTab = tab;
    const posTab = document.getElementById("tab-positions");
    const closedTab = document.getElementById("tab-closed");
    const cashTab = document.getElementById("tab-cash");
    const positionsBlock = document.getElementById("positionsBlock");
    const closedBlock = document.getElementById("closedBlock");
    const cashBlock = document.getElementById("cashBlock");
    const title = document.getElementById("activeTableTitle");

    if (tab === "positions") {
      posTab.classList.add("tab-pill-active");
      closedTab.classList.remove("tab-pill-active");
      cashTab.classList.remove("tab-pill-active");
      positionsBlock.style.display = "";
      closedBlock.style.display = "none";
      cashBlock.style.display = "none";
      title.textContent = "Open positions";
    } else if (tab === "closed") {
      closedTab.classList.add("tab-pill-active");
      posTab.classList.remove("tab-pill-active");
      cashTab.classList.remove("tab-pill-active");
      closedBlock.style.display = "";
      positionsBlock.style.display = "none";
      cashBlock.style.display = "none";
      title.textContent = "Closed trades";
    } else {
      cashTab.classList.add("tab-pill-active");
      posTab.classList.remove("tab-pill-active");
      closedTab.classList.remove("tab-pill-active");
      cashBlock.style.display = "";
      positionsBlock.style.display = "none";
      closedBlock.style.display = "none";
      title.textContent = "Deposits / withdrawals";
    }
  }

  function formatEquityLabel(ts, range) {
    const d = new Date(ts);
    if (range === "1d") {
      return d.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" });
    }
    return d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
  }

  // Map UI range -> backend ?period=
  function mapRangeToPeriod(range) {
    if (range === "1d") return "day";       // HL perpDay (13 points)
    if (range === "7d") return "week";      // HL perpWeek
    if (range === "30d") return "month";    // HL perpMonth
    if (range === "90d") return "90d";      // custom rolling 90d from perpAllTime
    return "allTime";                       // default = full history
  }

  function renderEquityChart(range) {
    const container = document.getElementById("chart-card");
    if (!Array.isArray(equitySeriesAll) || equitySeriesAll.length === 0) {
      container.style.display = "none";
      return;
    } else {
      container.style.display = "";
    }

    const dayMs = 24 * 60 * 60 * 1000;
    const firstTs = equitySeriesAll[0].ts;
    const lastTs  = equitySeriesAll[equitySeriesAll.length - 1].ts;
    const totalSpan = lastTs - firstTs;

    // Normal range windowing
    let cutoff = null;
    if (range === "1d")       cutoff = lastTs - dayMs;
    else if (range === "7d")  cutoff = lastTs - 7 * dayMs;
    else if (range === "30d") cutoff = lastTs - 30 * dayMs;
    else if (range === "90d") cutoff = lastTs - 90 * dayMs;

    let filtered = equitySeriesAll;
    if (cutoff !== null) {
      filtered = equitySeriesAll.filter(p => p.ts >= cutoff);

      // Fallback logic if too few points (except for 7D)
      let minPoints = 2;
      if (range === "1d") minPoints = 4;
      else if (range === "30d") minPoints = 4;

      if (range !== "7d" && filtered.length < minPoints) {
        const N = Math.min(10, equitySeriesAll.length);
        filtered = equitySeriesAll.slice(-N);
      }
    }

    // If the *total* span is â‰¤ 1 day, always show time-of-day labels
    const labelRange = totalSpan <= dayMs ? "1d" : range;

    const labels = filtered.map(p => formatEquityLabel(p.ts, labelRange));
    const values = filtered.map(p => p.equity);

    const ctx = document.getElementById("equityChart").getContext("2d");
    if (equityChart) {
      equityChart.data.labels = labels;
      equityChart.data.datasets[0].data = values;
      equityChart.update();
    } else {
      equityChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Perp balance",
              data: values,
              borderWidth: 2,
              pointRadius: 2,
              pointHitRadius: 6,
              tension: 0.25,
              borderColor: "rgba(56,189,248,0.95)",
              backgroundColor: "rgba(56,189,248,0.25)",
              fill: false,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(ctx) {
                  return "Perp balance: " + formatNumber(ctx.parsed.y, 2);
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { maxTicksLimit: 6 },
              grid: { display: false },
            },
            y: {
              ticks: {
                callback: function(value) { return formatNumber(value, 0); },
              },
              grid: { color: "rgba(31,41,55,0.7)" },
            },
          },
        },
      });
    }

    document.querySelectorAll(".range-btn").forEach(btn => {
      if (btn.dataset.range === range) {
        btn.classList.add("range-btn-active");
      } else {
        btn.classList.remove("range-btn-active");
      }
    });
  }

  function renderPnlChart(tsList, values) {
  if (!Array.isArray(tsList) || !Array.isArray(values) || tsList.length === 0) {
    const pnlCard = document.getElementById("pnl-chart-card");
    if (pnlCard) pnlCard.style.display = "none";
    return;
  }

  const pnlCard = document.getElementById("pnl-chart-card");
  if (!pnlCard) return;

  pnlCard.style.display = "block";

  const ctx2 = document.getElementById("pnlChart");
  if (!ctx2) return;

  if (pnlChart) {
    pnlChart.destroy();
    pnlChart = null;
  }

  pnlChart = new Chart(ctx2, {
    type: "line",
    data: {
      labels: tsList.map((ts) =>
        formatEquityLabel(ts, currentRange === "1d")
      ),
      datasets: [
        {
          label: "Perp PnL",
          data: values,
          borderWidth: 2,
          pointRadius: 2,
          pointHitRadius: 6,
          tension: 0.25,
          borderColor: "rgba(34,197,94,0.95)",     // greenish
          backgroundColor: "rgba(34,197,94,0.20)", // transparent green
          fill: true,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          ticks: {
            callback: (val) => formatNumber(val, 2),
          },
        },
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => "PnL: " + formatNumber(ctx.parsed.y, 2),
          },
        },
      },
    },
  });
}

  async function runFetch(skipRedirect, rangeOverride, options = {}) {
    const updateTables = options.updateTables !== false; // default true

    const baseUrlInput = document.getElementById("baseUrl");
    const accountInput = document.getElementById("account");
    const statusEl = document.getElementById("status");
    const fetchBtn = document.getElementById("fetchBtn");

    const baseUrlRaw = baseUrlInput.value.trim();
    const account = accountInput.value.trim();

    // UI range (graph buttons): all, 90d, 30d, 7d, 1d
    const uiRange = rangeOverride || currentRange || "all";
    currentRange = uiRange;

    // Backend ?period value: day/week/month/allTime/90d
    const period = mapRangeToPeriod(uiRange);

    if (!baseUrlRaw || !account) {
      statusEl.textContent = "Please enter both base URL and account address.";
      statusEl.className = "status status-error";
      return;
    }

    const currentUrl = new URL(window.location.href);
    const hasAccountInUrl = !!currentUrl.searchParams.get("account");

    if (!skipRedirect && !hasAccountInUrl) {
      currentUrl.searchParams.set("account", account);
      currentUrl.searchParams.set("period", uiRange); // store UI range in URL
      currentUrl.searchParams.set("base", baseUrlRaw);
      window.location.href = currentUrl.toString();
      return;
    }

    setDetailMode(true);
    switchTab("positions");

    let baseUrl = baseUrlRaw.replace(/\/+$/, "");
    const url =
      baseUrl +
      "/pnlClean?account=" +
      encodeURIComponent(account) +
      "&period=" +
      encodeURIComponent(period) +
      (updateTables ? "&positions=1&closed=1" : "&positions=0&closed=0");

    statusEl.textContent = "Fetching from " + url + " â€¦";
    statusEl.className = "status";
    fetchBtn.disabled = true;

    try {
      const res = await fetch(url, {
        method: "GET",
        headers: { Accept: "application/json" },
      });

      if (!res.ok) {
        const text = await res.text();
        statusEl.textContent = "Request failed: " + res.status + " " + res.statusText;
        statusEl.className = "status status-error";
        console.error("Error response body:", text);
        return;
      }

      const data = await res.json().catch(() => null);
      if (!data) {
        statusEl.textContent = "Received a non-JSON response from the Worker.";
        statusEl.className = "status status-error";
        return;
      }

      statusEl.textContent = "OK Â· Response received.";
      statusEl.className = "status status-ok";

      // raw JSON block
      const rawBlock = document.getElementById("rawJsonBlock");
      const rawPre = document.getElementById("rawJson");
      rawPre.textContent = JSON.stringify(data, null, 2);
      rawBlock.style.display = "block";

      // account label top-right
      const accountLabel = document.getElementById("accountLabel");
      const accDisplay = (data.account || account || "").toString();
      accountLabel.textContent = accDisplay ? accDisplay.slice(0, 8) + "â€¦" : "";

      // summary badges
      const summaryBadges = document.getElementById("summaryBadges");
      const summaryMeta = document.getElementById("summaryMeta");
      summaryBadges.innerHTML = "";
      summaryMeta.innerHTML = "";

      const tradingPnl   = typeof data.perp_pnl === "number" ? data.perp_pnl : null;
      const portfolioPnl = typeof data.balance_change === "number" ? data.balance_change : null;

      const roiObj = data.roi || {};
      const tradingPct   = typeof roiObj.trading_pct === "number" ? roiObj.trading_pct : null;
      const portfolioPct = typeof roiObj.portfolio_pct === "number" ? roiObj.portfolio_pct : null;

      const pnlBadges = [];

      if (portfolioPnl !== null) {
        const color = portfolioPnl >= 0 ? "green" : "red";
        pnlBadges.push(
          createBadge("Portfolio PnL", "$" + formatNumber(portfolioPnl, 2), { color })
        );
      }
      if (tradingPnl !== null) {
        const color = tradingPnl >= 0 ? "green" : "red";
        pnlBadges.push(
          createBadge("Perp PnL", "$" + formatNumber(tradingPnl, 2), { color })
        );
      }
      if (portfolioPct !== null) {
        const color = portfolioPct >= 0 ? "green" : "red";
        pnlBadges.push(
          createBadge("Portfolio ROI", formatNumber(portfolioPct, 2) + "%", { color })
        );
      }
      if (tradingPct !== null) {
        const color = tradingPct >= 0 ? "green" : "red";
        pnlBadges.push(
          createBadge("Perp ROI", formatNumber(tradingPct, 2) + "%", { color })
        );
      }

      if (!pnlBadges.length) {
        summaryBadges.innerHTML =
          '<span style="font-size:0.78rem; color:var(--muted);">No PnL / ROI fields returned in response.</span>';
      } else {
        pnlBadges.forEach(b => summaryBadges.appendChild(b));
      }

      const anySummary =
        data.summary || data.portfolioSummary || data.portfolio || data.meta || null;

      const deposits =
        anySummary?.deposits ??
        anySummary?.deposited ??
        data.adjustments?.deposits ??
        null;

      const withdrawals =
        anySummary?.withdrawals ??
        anySummary?.withdrawn ??
        data.adjustments?.withdrawals ??
        null;

      const fees = anySummary?.fees ?? null;

      const metaBadges = [];
      if (deposits !== null) {
        metaBadges.push(createBadge("Deposits", "$" + formatNumber(deposits, 2)));
      }
      if (withdrawals !== null) {
        metaBadges.push(createBadge("Withdrawals", "$" + formatNumber(withdrawals, 2)));
      }
      if (fees !== null) {
        metaBadges.push(createBadge("Fees", "$" + formatNumber(fees, 2)));
      }

      const balances = data.balances || {};
      if (balances.perp_now != null) {
        metaBadges.push(
          createBadge("Perp balance now", "$" + formatNumber(balances.perp_now, 2))
        );
      }
      if (balances.portfolio_now != null) {
        metaBadges.push(
          createBadge("Portfolio balance now", "$" + formatNumber(balances.portfolio_now, 2))
        );
      }

      if (!metaBadges.length) {
        summaryMeta.innerHTML =
          '<span style="font-size:0.78rem; color:var(--muted);">No cashflow / balance meta returned.</span>';
      } else {
        metaBadges.forEach(b => summaryMeta.appendChild(b));
      }

      if (updateTables) {
        const positions = data.positions || data.openPositions || data.open || [];
        const closed = data.closed || data.closedTrades || data.trades || [];

        const fundingEvents = data.fundingEvents || [];
        const fundingSummary = data.fundingSummary || {};

        const positionsContainer = document.getElementById("positionsTableContainer");
        const closedContainer = document.getElementById("closedTableContainer");
        const cashContainer = document.getElementById("cashTableContainer");

        buildTable(positionsContainer, positions, { type: "positions" });
        buildTable(closedContainer, closed, { type: "closed" });

        renderFundingTable(cashContainer, fundingEvents, fundingSummary);

        const posCount = document.getElementById("positionsCount");
        const closedCount = document.getElementById("closedCount");
        const cashCount = document.getElementById("cashCount");

        posCount.textContent =
          "(" + (Array.isArray(positions) ? positions.length : 0) + ")";
        closedCount.textContent =
          "(" + (Array.isArray(closed) ? closed.length : 0) + ")";

        const perpEventsCount = fundingEvents.filter(
          (ev) => ev.kind === "perpTransfer",
        ).length;
        cashCount.textContent = "(" + perpEventsCount + ")";
      }

      // equity chart
      equitySeriesAll = Array.isArray(data.equitySeries)
        ? data.equitySeries
        : [];

      if (equitySeriesAll.length) {
        equitySeriesAll = equitySeriesAll
          .map((p) => ({
            ts: Number(p.ts ?? p[0]),
            equity: Number(p.equity ?? p[1]),
          }))
          .filter(
            (p) => Number.isFinite(p.ts) && Number.isFinite(p.equity),
          )
          .sort((a, b) => a.ts - b.ts);

        // ðŸ”¹ Render using the current UI range (all / 90d / 30d / 7d / 1d)
        renderEquityChart(currentRange);
      } else {
        const chartCard = document.getElementById("chart-card");
        chartCard.style.display = "none";
      }

      // PnL chart
      pnlSeriesAll = Array.isArray(data.pnlSeries)
        ? data.pnlSeries
        : [];

      if (pnlSeriesAll.length) {
        pnlSeriesAll = pnlSeriesAll
          .map((p) => ({
            ts: Number(p.ts ?? p[0]),
            pnl: Number(p.pnl ?? p[1]),
          }))
          .filter(
            (p) => Number.isFinite(p.ts) && Number.isFinite(p.pnl),
          )
          .sort((a, b) => a.ts - b.ts);

        const tsList = pnlSeriesAll.map((pt) => pt.ts);
        const values = pnlSeriesAll.map((pt) => pt.pnl);
        renderPnlChart(tsList, values);
      } else {
        const pnlCard = document.getElementById("pnl-chart-card");
        if (pnlCard) pnlCard.style.display = "none";
      }

    } catch (err) {
      console.error(err);
      statusEl.textContent = "Error: " + (err?.message || err);
      statusEl.className = "status status-error";
    } finally {
      fetchBtn.disabled = false;
    }
  }

  function handleSubmit(event) {
    if (event) event.preventDefault();
    // First manual fetch: use whatever currentRange is (default = "all")
    runFetch(false, currentRange, { updateTables: true });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const baseParam = params.get("base");
    const accountParam = params.get("account");
    const periodParam = params.get("period"); // this is our stored UI range now

    const baseInput = document.getElementById("baseUrl");
    const accountInput = document.getElementById("account");
    const periodSelect = document.getElementById("period"); // still present in DOM, but no longer used for API

    if (baseParam) baseInput.value = baseParam;
    if (accountParam) accountInput.value = accountParam;

    if (periodParam && ["all","90d","30d","7d","1d"].includes(periodParam)) {
      currentRange = periodParam;
    }

    // Keep the dropdown showing something sane (not used for backend anymore)
    if (periodSelect) {
      periodSelect.value = "allTime";
    }

    document.getElementById("query-form").addEventListener("submit", handleSubmit);

    if (accountParam) {
      setDetailMode(true);
      switchTab("positions");
      runFetch(true, currentRange, { updateTables: true });
    } else {
      setDetailMode(false);
    }

    document.getElementById("tab-positions").addEventListener("click", () => switchTab("positions"));
    document.getElementById("tab-closed").addEventListener("click", () => switchTab("closed"));
    document.getElementById("tab-cash").addEventListener("click", () => switchTab("cash"));

    document.querySelectorAll(".range-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const range = btn.dataset.range;
        currentRange = range;
        // Re-fetch PnL/ROI/equity for this window, but keep tables as-is
        runFetch(true, range, { updateTables: false });
      });
    });
  });
</script>
</body>
</html>
